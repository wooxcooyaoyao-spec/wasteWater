# 污泥处理系统参数计算工具 - 使用指南

## 工具概述

这是一个专为自来水处理污泥处理环节设计的参数计算和分析工具包。

**核心功能**：帮助操作人员理解和管理三个关键参数之间的联动关系：
- **MLSS**（混合液悬浮固体浓度）
- **Equivalent Flow**（等效流量）
- **Solids Loading Rate**（固体负荷率）

---

## 核心概念

### 1. MLSS Concentration（混合液悬浮固体浓度）
- **单位**：mg/L
- **安全范围**：2,000 - 5,400 mg/L
- **最优范围**：3,000 - 4,500 mg/L

### 2. Equivalent Flow（等效流量）
- **单位**：L/s
- **安全范围**：60 - 170 L/s
- **最优范围**：90 - 130 L/s

### 3. Solids Loading Rate（固体负荷率）
- **单位**：kg/h/m²
- **安全范围**：3.0 - 24.0 kg/h/m²
- **最优范围**：8.0 - 16.0 kg/h/m²

### 参数关系公式

```
SLR = (MLSS / 1000) × (EQ × 3.6) / 面积
```

---

## 目录结构

```
WasteWaterTool/
├── data/                           # 原始数据目录
│   └── MLSS浓度表.xlsx            # 输入的 Excel 表格
├── output/                         # 生成的分析结果
│   ├── 参数对比分析.xlsx
│   └── 敏感性分析.xlsx
├── doc/                            # 文档目录（本文件）
│   └── 使用指南.md
├── wastewater_treatment_calc.py   # 核心计算引擎
├── excel_handler.py                # Excel 处理模块
├── xlwings_integration.py         # xlwings 集成
└── __init__.py                     # 包初始化
```

---

## Windows 系统完整使用指南

> ⚠️ **重要提示**: 本工具需要 **Python 3** (推荐 3.8+)，不支持 Python 2.x
>
> **所有命令中请使用 `python3` 而不是 `python`**

### 第一步：准备环境

#### 1.1 安装 Python 3

1. 访问 [Python 官网](https://www.python.org/downloads/)
2. 下载 **Python 3.8+ 版本**（推荐 3.9 或 3.10）
3. 运行安装程序，**重要**：勾选 "Add Python to PATH"
4. 点击 "Install Now"

#### 1.2 验证 Python 3 安装

打开 Windows 命令行（Win + R，输入 `cmd`），执行：

```cmd
python3 --version
```

**必须看到 Python 3.x 的版本号**（如 `Python 3.10.5`），说明安装成功。如果出现"命令未找到"或 Python 2.x 版本，请重新安装 Python 3。

### 第二步：创建虚拟环境

#### 2.1 打开命令行进入工程目录

```cmd
# 例如，工程放在 D:\Projects\WastWaterTool
cd D:\Projects\WastWaterTool
```

#### 2.2 创建虚拟环境（使用 Python 3）

```cmd
# 创建虚拟环境，名称为 venv（必须使用 python3）
python3 -m venv venv
```

这会在工程目录下创建一个 `venv` 文件夹，包含完整的 Python 3 环境。

#### 2.3 激活虚拟环境

**在 Windows 命令行（CMD）中：**

```cmd
venv\Scripts\activate
```

**在 Windows PowerShell 中：**

```powershell
venv\Scripts\Activate.ps1
```

激活成功后，命令行前缀会显示 `(venv)`，例如：

```cmd
(venv) D:\Projects\WastWaterTool>
```

### 第三步：安装依赖

确保虚拟环境已激活（看到 `(venv)` 提示），执行：

```cmd
pip install -r requirements.txt
```

这会自动安装：
- `openpyxl` - Excel 文件处理
- `xlwings` - Excel 与 Python 集成

#### 3.1 验证安装（使用 Python 3）

```cmd
python3 -c "import openpyxl; print(f'openpyxl {openpyxl.__version__}')"
python3 -c "import xlwings; print(f'xlwings {xlwings.__version__}')"
```

如果都有输出版本号，说明安装成功。

### 第四步：使用工具（使用 Python 3）

#### 方式 A：运行演示脚本（推荐新手）

```cmd
python3 use_wastewater_tool.py
```

这会演示工具的所有功能，并在 `output/` 目录下生成分析报告。

#### 方式 B：在 Python 代码中使用

创建文件 `my_test.py`：

```python
from WasteWaterTool.wastewater_treatment_calc import WastewaterCalculator

# 初始化计算器
calc = WastewaterCalculator()

# 计算 SLR
slr = calc.calculate_slr(mlss=3500, equivalent_flow=100)
print(f"SLR = {slr:.2f} kg/h/m²")

# 检查安全性
check = calc.check_operating_point(3500, 100)
print(f"安全运行: {check['overall_safe']}")
```

然后使用 Python 3 运行：

```cmd
python3 my_test.py
```

#### 方式 C：生成 Excel 分析报告

创建文件 `analysis.py`：

```python
from WasteWaterTool.excel_handler import ExcelDataHandler

# 初始化处理器
handler = ExcelDataHandler()

# 定义不同的运行场景
scenarios = {
    '保守模式': {'mlss': 2800, 'flow': 80},
    '平衡模式': {'mlss': 3500, 'flow': 100},
    '高效模式': {'mlss': 4200, 'flow': 130},
}

# 生成对比报告
handler.create_comparison_excel('output/运行模式对比.xlsx', scenarios)
print("对比分析报告已生成: output/运行模式对比.xlsx")

# 生成敏感性分析
handler.create_sensitivity_analysis('output/敏感性分析.xlsx')
print("敏感性分析报告已生成: output/敏感性分析.xlsx")
```

然后使用 Python 3 运行：

```cmd
python3 analysis.py
```

### 第五步：常见问题

#### Q1：如何退出虚拟环境？

```cmd
deactivate
```

#### Q2：下次使用时是否需要重新安装依赖？

不需要。虚拟环境中的依赖已安装，下次使用时只需激活虚拟环境即可：

```cmd
venv\Scripts\activate
python3 use_wastewater_tool.py
```

#### Q3：Excel 文件打不开怎么办？

- 确保安装了 Microsoft Excel 2010 或更高版本
- 尝试用 Excel 直接打开，检查文件内容
- 重新生成文件：`python3 use_wastewater_tool.py`

#### Q4：Import 错误怎么办？

常见错误：`ModuleNotFoundError: No module named 'WasteWaterTool'`

**解决方案**：

1. 确保虚拟环境已激活（看到 `(venv)` 提示）
2. **确保使用 `python3` 而不是 `python`**
3. 在工程根目录运行，不要在子目录中运行
4. 如果仍有问题，重新安装：
   ```cmd
   python3 -m pip install -e .
   ```

#### Q5：如何清理虚拟环境重新开始？

```cmd
# 1. 退出虚拟环境
deactivate

# 2. 删除虚拟环境文件夹
rmdir /s venv

# 3. 重新创建（使用 python3）
python3 -m venv venv
venv\Scripts\activate
pip install -r requirements.txt
```

#### Q6：如何确认我使用的是 Python 3？

```cmd
# 激活虚拟环境后运行
python3 --version
```

**必须显示 Python 3.x 版本号**（如 `Python 3.10.5`）

### 第六步：快速参考

#### 完整工作流（使用 Python 3）

```cmd
# 1. 进入工程目录
cd D:\Projects\WastWaterTool

# 2. 激活虚拟环境
venv\Scripts\activate

# 3. 运行工具（使用 python3）
python3 use_wastewater_tool.py

# 4. 查看输出
# output/ 目录下会生成 Excel 文件

# 5. 退出虚拟环境
deactivate
```

#### 编辑和运行自己的脚本（使用 Python 3）

```cmd
# 1. 激活虚拟环境
venv\Scripts\activate

# 2. 使用编辑器编辑 my_script.py
# （可使用 Notepad++、VS Code 等）

# 3. 运行脚本（使用 python3）
python3 my_script.py
```

---

## 使用方法

### 方法 1：Python 代码调用（推荐用于集成）

#### 基础计算

```python
from wastewater_treatment_calc import WastewaterCalculator

# 初始化计算器
calc = WastewaterCalculator(area=1.0)

# 计算 SLR
slr = calc.calculate_slr(mlss=3500, equivalent_flow=100)
print(f"SLR = {slr:.2f} kg/h/m²")
```

#### 检查运行安全性

```python
# 检查某个运行点是否在安全范围内
check = calc.check_operating_point(mlss=3500, equivalent_flow=100)

print(f"整体安全: {check['overall_safe']}")
for rec in check['recommendations']:
    print(f"  {rec}")
```

#### 参数反推

```python
# 已知 SLR 和 Flow，求 MLSS
mlss = calc.calculate_mlss(slr=12, equivalent_flow=90)
print(f"推导的 MLSS: {mlss:.0f} mg/L")

# 已知 MLSS 和 SLR，求 Flow
flow = calc.calculate_equivalent_flow(mlss=3500, slr=12)
print(f"推导的 Flow: {flow:.2f} L/s")
```

### 方法 2：生成 Excel 分析报告

```python
from excel_handler import ExcelDataHandler

# 初始化处理器（会自动查找 data 目录下的 MLSS浓度表.xlsx）
handler = ExcelDataHandler()

# 生成对比分析
variations = {
    '基准运行': {'mlss': 3500, 'flow': 100},
    '高流量': {'mlss': 3500, 'flow': 120},
    '高浓度': {'mlss': 4000, 'flow': 100},
}
handler.create_comparison_excel('output/对比分析.xlsx', variations)

# 生成敏感性分析
handler.create_sensitivity_analysis('output/敏感性分析.xlsx')
```

### 方法 3：直接运行脚本

在项目根目录下，运行提供的使用脚本：

```bash
python use_wastewater_tool.py
```

---

## Excel 文件说明

### 输入文件：data/MLSS浓度表.xlsx

标准格式为：
- **第一行**：MLSS 值（2000, 2200, 2400, ...）
- **第二行**：副标题（Equivalent (L/s) 标签）
- **第三行及之后**：数据行
  - 第一列：Equivalent (L/s) 值（60, 65, 70, ...）
  - 其他列：对应 SLR 值

### 输出文件

#### 参数对比分析.xlsx
对比多个运行场景，显示：
- MLSS、流量、SLR 值
- 各参数状态（过低/正常/过高/最优）
- 整体安全评估（✓/✗）

#### 敏感性分析.xlsx
包含两个 Sheet：
1. **MLSS变化影响**：固定流量，改变 MLSS 对 SLR 的影响
2. **流量变化影响**：固定 MLSS，改变流量对 SLR 的影响

---

## 常见使用场景

### 场景 1：快速参数验证

**问题**：已知 MLSS=3800 mg/L，EQ=110 L/s，是否安全运行？

```python
calc = WastewaterCalculator()
check = calc.check_operating_point(3800, 110)
if check['overall_safe']:
    print("✓ 可以安全运行")
else:
    print("✗ 需要调整参数")
    for rec in check['recommendations']:
        print(f"  {rec}")
```

### 场景 2：参数设计

**问题**：目标 SLR=12 kg/h/m²，流量最多 90 L/s，需要 MLSS 多少？

```python
calc = WastewaterCalculator()
mlss_needed = calc.calculate_mlss(slr=12, equivalent_flow=90)
print(f"需要 MLSS: {mlss_needed:.0f} mg/L")

# 验证是否安全
check = calc.check_operating_point(mlss_needed, 90)
print(f"安全性: {check['overall_safe']}")
```

### 场景 3：对比分析

**问题**：比较不同运行策略的效果

```python
handler = ExcelDataHandler()
scenarios = {
    '保守策略': {'mlss': 3000, 'flow': 80},
    '平衡策略': {'mlss': 3500, 'flow': 100},
    '激进策略': {'mlss': 4200, 'flow': 130},
}
handler.create_comparison_excel('output/策略对比.xlsx', scenarios)
```

---

## 工具特点

✓ **相对路径设计**：工具可独立使用，支持任意位置放置
✓ **灵活的参数配置**：支持自定义面积、数据目录、输出目录
✓ **完整的参数验证**：自动检查参数是否在安全范围内
✓ **智能建议系统**：根据参数给出针对性的调整建议
✓ **多种输出格式**：支持 Python 调用、Excel 报告、可视化分析

---

## 技术细节

### 模块说明

#### wastewater_treatment_calc.py
核心计算模块，提供：
- `WastewaterCalculator` 类：参数计算和验证
- `SAFETY_RANGES` 字典：安全范围定义

#### excel_handler.py
Excel 数据处理模块，提供：
- `ExcelDataHandler` 类：读取、解析、生成 Excel
- 支持对比分析和敏感性分析

#### xlwings_integration.py
Excel 集成模块，提供：
- `WastewaterExcelFunctions` 类：可在 Excel 中使用的函数
- 支持创建交互式仪表板

---

## 扩展和集成

### 与其他系统集成

```python
# 导入工具
from wastewater_treatment_calc import WastewaterCalculator

# 在现有系统中使用
def check_system_parameters(mlss, flow):
    calc = WastewaterCalculator()
    check = calc.check_operating_point(mlss, flow)
    return check['overall_safe']
```

### 自定义配置

```python
# 修改安全范围
calc = WastewaterCalculator(area=2.5)  # 设置不同的处理面积
```

---

## 故障排除

### 问题 1：找不到 Excel 文件

**原因**：数据目录结构不正确

**解决**：
1. 确保 `data/MLSS浓度表.xlsx` 存在
2. 检查文件名是否完全匹配
3. 检查编码是否正确

### 问题 2：计算结果异常

**原因**：参数单位或计算面积错误

**解决**：
1. 确认 MLSS 单位为 mg/L
2. 确认流量单位为 L/s
3. 检查处理面积设置

### 问题 3：Excel 输出格式问题

**原因**：openpyxl 版本或 Excel 软件兼容性

**解决**：
1. 更新 openpyxl：`pip install --upgrade openpyxl`
2. 使用 Excel 2016 及以上版本
3. 重新生成文件

---

## 许可和支持

本工具为开源工具，可在遵守相关许可证的前提下自由使用和修改。

如有问题或建议，欢迎反馈！

